<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>網羅系 乱数問題ガチャ</title>
  <style>
    :root{font-family: system-ui,-apple-system,'Segoe UI',Roboto,'Hiragino Kaku Gothic ProN', 'Noto Sans JP',sans-serif}
    body{margin:0;padding:18px;background:#f6f8fa;color:#0b1220}
    .app{max-width:820px;margin:0 auto;background:white;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(10,25,41,0.08)}
    h1{font-size:1.25rem;margin:0 0 8px}
    p.lead{margin:0 0 16px;color:#374151}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:1px solid #eef2f7}
    .field input[type=checkbox]{width:20px;height:20px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:#0b69ff;color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e6eefc;color:#08306b}
    .result{margin-top:14px;padding:12px;border-radius:8px;background:#f3f6ff;border:1px solid #e1e9ff}
    .result-list{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:white;padding:8px 10px;border-radius:8px;border:1px solid #dbeafe;min-width:120px}
    .history{margin-top:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    .small{font-size:0.85rem;color:#475569}
    .actions{display:flex;gap:8px}
    textarea{width:100%;height:120px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <h1>網羅系 乱数問題ガチャ</h1>
    <p class="lead">分野を選んで「生成」を押すだけ。結果は履歴に保存できます。スマホでも動作します。共有はエクスポート／インポートで。</p>

    <div class="grid" id="fields">
      <!-- fields added by JS -->
    </div>

    <div class="controls">
      <button id="generateBtn">生成</button>
      <button class="secondary" id="generateTodayBtn">今日の日付で生成（固定保存）</button>
      <button class="secondary" id="copyBtn">コピー</button>
      <button class="secondary" id="downloadBtn">履歴をエクスポート</button>
      <label class="secondary" style="display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer">
        <input type="file" id="importFile" style="display:none" accept="application/json"> インポート
      </label>
      <button class="secondary" id="clearHistoryBtn">履歴クリア</button>
    </div>

    <div class="result" id="resultArea" aria-live="polite">
      <div class="result-list" id="resultList"></div>
      <div class="small" id="resultNote">まだ生成されていません。</div>
    </div>

    <div class="history" id="historyArea">
      <h2 style="font-size:1rem;margin-top:16px">履歴</h2>
      <div class="small">※ローカル（このブラウザ）のみ保存されます。別の端末と共有するにはエクスポート／インポートを使ってください。</div>
      <table id="historyTable">
        <thead><tr><th>日付</th><th>結果</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <details style="margin-top:12px">
      <summary>使い方（短く）</summary>
      <ol>
        <li>やりたい分野のチェックを入れる。</li>
        <li>「生成」を押すと乱数が出ます。</li>
        <li>気に入ったら「今日の日付で生成」を押すと、その結果が日付つきで履歴へ保存されます。</li>
        <li>履歴は「エクスポート」してファイルを共有できます。受け取ったら「インポート」してください。</li>
      </ol>
    </details>
  </div>

<script>
// 分野と範囲定義（日本語ラベル）
const FIELDS = [
  {key:'数I', min:1, max:139},
  {key:'数A', min:155, max:293},
  {key:'数II', min:1, max:245},
  {key:'数B', min:1, max:66},
  {key:'ベクトル', min:1, max:81},
  {key:'数C', min:1, max:84},
  {key:'数III', min:1, max:221}
];

const fieldsDiv = document.getElementById('fields');
const resultList = document.getElementById('resultList');
const resultNote = document.getElementById('resultNote');
const historyTableBody = document.querySelector('#historyTable tbody');
const STORAGE_KEY = 'moh_gacha_history_v1';
let lastResult = null;

function buildUI(){
  FIELDS.forEach((f, i) =>{
    const el = document.createElement('div');
    el.className='field';
    el.innerHTML = `
      <input type="checkbox" id="cb_${i}" checked>
      <label for="cb_${i}"><strong>${f.key}</strong><div class="small">${f.min}–${f.max}</div></label>
    `;
    fieldsDiv.appendChild(el);
  });
}

// crypto-based unbiased integer in [min,max]
function randInt(min,max){
  const range = max - min + 1;
  if(range <= 0) return min;
  const maxUint32 = 0xFFFFFFFF;
  const limit = Math.floor((maxUint32 + 1) / range) * range;
  const uint32 = new Uint32Array(1);
  while(true){
    window.crypto.getRandomValues(uint32);
    if(uint32[0] < limit) return min + (uint32[0] % range);
  }
}

function gen(selectedOnly=false){
  const chosen = {};
  FIELDS.forEach((f,i)=>{
    const cb = document.getElementById('cb_'+i);
    if(cb.checked) chosen[f.key] = randInt(f.min, f.max);
    else if(!selectedOnly) chosen[f.key] = randInt(f.min, f.max);
  });
  lastResult = {ts: new Date().toISOString(), data: chosen};
  renderResult(lastResult);
  return lastResult;
}

function renderResult(res){
  resultList.innerHTML='';
  for(const k of Object.keys(res.data)){
    const v = res.data[k];
    const chip = document.createElement('div');
    chip.className='chip';
    chip.innerHTML = `<strong>${k}</strong><div class='small'>例題 ${v}</div>`;
    resultList.appendChild(chip);
  }
  resultNote.textContent = `生成: ${new Date(res.ts).toLocaleString()}`;
}

function saveToHistory(entry){
  const hist = loadHistory();
  hist.unshift(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(hist));
  renderHistory();
}

function loadHistory(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){return []}
}

function renderHistory(){
  const hist = loadHistory();
  historyTableBody.innerHTML='';
  hist.forEach((h, idx)=>{
    const tr = document.createElement('tr');
    const dateTd = document.createElement('td');
    dateTd.textContent = new Date(h.ts).toLocaleString();
    const dataTd = document.createElement('td');
    dataTd.innerHTML = Object.keys(h.data).map(k=>`<strong>${k}</strong>: ${h.data[k]}`).join('<br>');
    const opTd = document.createElement('td');
    opTd.className='actions';
    const loadBtn = document.createElement('button'); loadBtn.textContent='表示';
    loadBtn.addEventListener('click', ()=>{ lastResult = h; renderResult(h); });
    const copyBtn = document.createElement('button'); copyBtn.textContent='コピー';
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(JSON.stringify(h.data)).then(()=>alert('コピーしました')) });
    const delBtn = document.createElement('button'); delBtn.textContent='削除'; delBtn.style.background='#ff6b6b';
    delBtn.addEventListener('click', ()=>{ if(confirm('削除しますか？')){ deleteHistoryAt(idx); } });
    opTd.appendChild(loadBtn); opTd.appendChild(copyBtn); opTd.appendChild(delBtn);
    tr.appendChild(dateTd); tr.appendChild(dataTd); tr.appendChild(opTd);
    historyTableBody.appendChild(tr);
  });
}

function deleteHistoryAt(idx){
  const hist = loadHistory();
  hist.splice(idx,1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(hist));
  renderHistory();
}

function clearHistory(){
  if(!confirm('履歴を完全に消してよいですか？')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderHistory();
}

function downloadHistory(){
  const hist = loadHistory();
  const blob = new Blob([JSON.stringify(hist, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'moh_gacha_history.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function importHistoryFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const parsed = JSON.parse(reader.result);
      if(!Array.isArray(parsed)) throw new Error('形式不正');
      // マージ
      const existing = loadHistory();
      const merged = parsed.concat(existing);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
      renderHistory();
      alert('インポート完了');
    }catch(e){alert('インポートに失敗しました: '+e.message)}
  };
  reader.readAsText(file);
}

// copy last result as human-friendly text
function copyLast(){
  if(!lastResult){alert('まず生成してください');return}
  const lines = Object.keys(lastResult.data).map(k=>`${k}: ${lastResult.data[k]}`);
  const txt = `【網羅系乱数】 ${new Date(lastResult.ts).toLocaleString()}\n` + lines.join('\n');
  navigator.clipboard.writeText(txt).then(()=>alert('コピーしました'));
}

// fixed-date save
function saveToday(){
  if(!lastResult){alert('まず生成してください');return}
  const entry = {...lastResult};
  // set date to today's midnight iso (user's locale)
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth(), d=now.getDate();
  const isoDate = new Date(y,m,d).toISOString();
  entry.ts = isoDate;
  saveToHistory(entry);
  alert('保存しました('+new Date(entry.ts).toLocaleDateString()+')');
}

// init
buildUI(); renderHistory();

// bindings
document.getElementById('generateBtn').addEventListener('click', ()=>gen(true));
document.getElementById('generateTodayBtn').addEventListener('click', ()=>{ gen(true); saveToday(); });
document.getElementById('copyBtn').addEventListener('click', copyLast);
document.getElementById('downloadBtn').addEventListener('click', downloadHistory);
document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
document.getElementById('importFile').addEventListener('change', (e)=>{ if(e.target.files.length) importHistoryFile(e.target.files[0]); });

</script>
</body>
</html>
